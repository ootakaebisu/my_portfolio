<div class="row">
  <div class="col-sm-3">
    <% if current_user.missions.present? && current_user.missions.find_by(status: "doing").present? %>
      <%= render 'layouts/side', { daily_clear: @daily_clear, daily_clear_status: @daily_clear_status, mission: @mission, user: current_user } %>
    <% else %>
       <%= render 'layouts/side', { user: current_user } %>
    <% end %>
  </div>


  <div class="col-sm-9 pr-5">
    <!--status："doing"のMissionがある時-->

    <% if current_user.missions.present? && current_user.missions.find_by(status: "doing").present? %>
    <!--ミッションがある時の挙動-->
      <h2 class="left">Record</h2><br>
      <div class="line"></div>

      <div class="col-sm-6 offset-sm-3 totsu mt-4">
        <% if @mission.small_goals.present? && @mission.small_goals.where(status: "doing").present? %>
          <%= @mission.small_goals.where(status: "doing").first.title %>
        <% else %>
          <%= @mission.title %>
        <% end %>
      </div>

      <div class="text-center mt-3 mb-3">
        <%= image_tag 'yagirushi.jpg', size: '100x100' %>
      </div>

      <div class="row ml-0 mr-0 color-3 justify-content-center mb-3">
        <div class="col-sm-1"></div>
        <div class="col-sm-3 left"><%= "Total " + @daily_records.to_s %></div>
        <div class="col-sm-4 text-center"><h2 class="mb-0 pb-0">Record</h2></div>
        <div class="col-sm-3 right"><%= link_to "TimeAttackへ", mission_path(@mission.id), class: "btn" %></div>
        <div class="col-sm-1"></div>
      </div>

      <div class="col-sm-10 offset-sm-1 pl-0 pr-0">
        <div class="line mt-0"></div>

        <div>
          <!--作成/Recordデータ-->
          <%= form_with model: @record, local: true do |f| %>
            <%= f.hidden_field :mission_id, :value => @mission.id %>
            <table class="row mr-0 ml-0">
              <tbody class="col-sm-12 pl-0 pr-0">
                <tr class="row mr-0 ml-0">
                  <td class="col-sm-9 pl-1 pr-1"><%= f.text_field :title, class: "col-sm-12 btn_ou" %></td>
                  <td class="col-sm-3 pl-1 pr-1"><%= f.submit "Record", class: "col-sm-12 btn" %></td>
                </tr>
              </tbody>
            </table>
          <% end %>



          <!--表示/Recordデータ-->
          <% if @records.present? %>
          <% @records.each do |record| %>

              <table class="row mr-0 ml-0">
                <tbody class="col-sm-12 pl-0 pr-0">
                  <tr class="row mr-0 ml-0">
                    <td class="col-sm-9 pl-2 pr-1 pt-3 pb-2"><%= record.title %></td>
                    <td class="col-sm-3 pl-1 pr-1 pt-1 pb-2 text-center"><%= link_to '×', record_path(record.id), method: :delete %></td>
                  </tr>
                </tbody>
              </table>
            <% end %>
          <% end %>
        </div>



        <div class="line"></div>
        <!--後々JSのポップアップにする部分-->
        <!--ミッション概要部分-->

        <div>
          <%= @mission.title %>
          <% if @mission.deadline_on.present? %>
            <%= @mission.deadline_on %>
          <% end %>
          <%= link_to "(鉛筆icon)", edit_mission_path(@mission.id) %>
        </div>

      <!--スモールゴール部分-->
        <div>
          <label>Small Goal</label>
          <!--表示-->
            <!--スモールゴールがある時-->
            <% if @mission.small_goals.present? %>
              <% @mission.small_goals.each do |small_goal| %>

                <!--スモールゴールタイトル-->
                <%= small_goal.title %>

                <!--スモールゴール期日(あれば)-->
                <% if small_goal.deadline_on.present? %>
                  <%= small_goal.deadline_on %>
                <% end %>

                <!--スモールゴールの着手状況とその変更-->
                <% if small_goal.status == "before" %>
                  <%= form_with model: small_goal, local: true do |f| %>
                    <%= f.hidden_field :status, :value => "doing" %>
                    <%= f.submit "Start" %>
                  <% end %>
                <% elsif small_goal.status == "doing" %>
                  <%= form_with model: small_goal, local: true do |f| %>
                    <%= f.hidden_field :status, :value => "after" %>
                    <%= f.submit "Finish" %>
                  <% end %>
                <% elsif small_goal.status == "after" %>
                  <p>Clear!</p>
                <% end %>

                <!--スモールゴールの削除(status:before/doing時)orステータスを着手前に戻す(status:after時)-->
                <% if small_goal.status == "before" || small_goal.status == "doing" %>
                  <%= link_to "(×)", small_goal_path(small_goal.id), method: :delete %>
                <% elsif small_goal.status == "after" %>
                  <%= form_with model: small_goal, local: true do |f| %>
                    <%= f.hidden_field :status, :value => "before" %>
                    <%= f.submit "(←)" %>
                  <% end %>
                <% end %>
              <% end %>

            <!--スモールゴールがない時-->
            <% else %>
              <p>スモールゴールが登録されていません</p>
            <% end %>

          <!--作成-->
            <%= form_with model: @small_goal, url:small_goals_path, local: true do |f| %>
              <%= f.hidden_field :mission_id, :value => @mission.id %>
              <%= f.text_field :title %>
              <%= f.date_field :deadline_on %>
              <%= f.submit %>
            <% end %>
        </div>

    <!--status："doing"のMissionがない時-->
    <% else %>
    <div class="text-center col-sm-9 mt-5">
      <h3>Create Mission</h3>
      <p>早速ミッションを作成しましょう！</p>
      <div class="totsu col-sm-6 center">
        <label>新しいミッションを開始する</label><br>
        <%= link_to "New Mission", new_mission_path, class: "btn" %>
      </div>
    </div>


    <% end %>
  </div>
</div>



